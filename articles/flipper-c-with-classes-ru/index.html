<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="description" content="Как я писал под Флиппер на Си-с-классами. Добавляем raii и другие ништяки. iliazeus" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="alternate" type="application/atom+xml" href="https://iliazeus.lol/atom.xml">

    <link
      rel="preload" as="style"
      href="https://code.cdn.mozilla.net/fonts/fira.css"
      onload="this.onload=null;this.rel='stylesheet'"
    />

    <style>.if-not-js { display: none !important }</style>
    <noscript><style>
      .if-js { display: none !important }
      .if-not-js { display: unset !important }
    </style></noscript>

    <script src="/theme.js"></script>
    <link rel="stylesheet" href="/style.css" />

    <title>Как я писал под Флиппер на Си-с-классами | iliazeus</title>
  </head>

  <body>
    <a href="#" class="local if-js theme-toggle" style="cursor: pointer; position: absolute; right: 8px; top: 8px">toggle dark theme</a>

    <header>
      <hgroup>
        <h1><a href="/" title="go to main page">iliazeus</a></h1>
        <nav>
          <ul class="horizontal small">
            <li><a rel="me" href="https://github.com/iliazeus">github</a></li>
            <li><a rel="me" href="https://habr.com/users/iliazeus">habr</a></li>
            <li><a rel="me" href="https://lor.sh/@iliazeus">mastodon</a></li>
            <li><a rel="me" href="mailto:iliazeus@proton.me">mailto</a></li>
          </ul>
        </nav>
        <p>илья, иль не я</p>
      </hgroup>
    </header>

    <main>
      <hgroup>
        <h2>Как я писал под Флиппер на Си-с-классами</h2>
        <ul class="horizontal">
          <li>2023-10-19</li>
          <li>ru</li>
          
          <li><a target="_blank" href="https:&#x2F;&#x2F;creativecommons.org&#x2F;licenses&#x2F;by-sa&#x2F;4.0&#x2F;"  rel="license" >CC BY-SA 4.0</a></li>
          
          <li><a target="_blank" href="https:&#x2F;&#x2F;habr.com&#x2F;ru&#x2F;articles&#x2F;768658&#x2F;"  rel="alternate" >habr</a></li>
          
        </ul>
      </hgroup>

      <p>Мой <a href="https://flipperzero.one/">Флиппер</a> дошел до меня больше полугода назад, но что-то под него написать я собрался только сейчас. Его API рассчитаны на язык С — а у меня с ним опыта не очень много. Но проблем с тулингом не возникло — у Флиппера есть своя <a href="https://github.com/flipperdevices/flipperzero-firmware/blob/dev/documentation/fbt.md">система сборки</a>, которая скачала мне нужный тулчейн и сгенерировала настройки для IDE.</p>
<p>А для написания кода я решил использовать все же не C, а C++ — точнее, даже "Си-с-классами". На мой взгляд, затуманенный языками более высокого уровня, такой подход получился удобнее, чем писать на чистом C. Результат можно увидеть <a href="https://github.com/iliazeus/furi-cpp">в моем репозитории</a>, а в этой статье я попытаюсь описать, какие конкретные фичи языка я использовал, и как именно они мне помогли.</p>
<p><img src="https://iliazeus.lol/articles/flipper-c-with-classes-ru/cover.png" alt="демонстрация того, что у меня получилось" /></p>
<p>Сразу скажу, что моей целью не было написание полноценных C++-биндингов для API флиппера. Конечно же, обернув функции здешнего API в классы, используя конструкторы и деструкторы вместо <code>_alloc()</code>- и <code>_free()</code>-функций, а некоторые интерфейсы переписав совсем, я смог бы писать намного более идиоматичный код с точки зрения современного C++. Однако это потребовало бы намного больших затрат времени на написание, документацию и поддержку. Вместо этого, я искал от C++ способы как можно более простым способом избавиться от самых больших неудобств — некоторыми из которых и хочу с вами поделиться.</p>
<h2 id="prostranstva-imen"><a class="anchor" href="#prostranstva-imen" title="link to section">#</a>Пространства имен</h2>
<p>В сишных API функции и константы, как правило, называются с длинными префиксами: <code>mylib_mything_get_foo()</code>, <code>MylibMyenumFirst</code>. Порой это делает код чрезвычайно многословным — особенно в тех случаях, когда из контекста функции вполне понятно, что <code>get_foo()</code> мы вызываем именно для <code>mything</code> из библиотеки <code>mylib</code>. Поэтому, прежде всего, я хотел раскидать имена по отдельным пространствам имен.</p>
<p>Для типов это можно сделать, просто добавив типы-аласы. Вроде таких:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">Timer</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriTimer<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">Mutex</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutex<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>Для функций все чуть более интересно:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>mutex</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-storage z-modifier z-c++">constexpr</span> <span class="z-storage z-modifier z-c++">inline</span> <span class="z-storage z-type z-c">auto</span><span class="z-keyword z-operator z-c++">&amp;</span> acquire <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_acquire<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>Подход с ссылками имеет сразу несколько плюсов. Во-первых, <code>constexpr</code>-ссылки гарантированно хорошо инлайнятся, превращаясь просто в вызовы оригиналов — в моих тестах у меня не было не-встроенных вызовов. Во-вторых, это - в отличие, например, от написания оберток — не требует повторять сигнатуру исходной функции. Более того, моя IDE даже подтянула для таких ссылок документацию оригиналов:</p>
<p><img src="https://iliazeus.lol/articles/flipper-c-with-classes-ru/function-reference-docs.png" alt="пример документации во всплывающей подсказке IDE" /></p>
<p>Для того, чтобы не писать в каждой строчке <code>constexpr inline auto&amp;</code>, я определил для этого макрос <code>FURI_HH_ALIAS</code>. Для макросов в C++, к сожалению, пространств имен нет, поэтому его пришлось назвать с префиксом.</p>
<p>Остались только <code>enum</code>ы. Идиоматичным C++ было бы использовать для них <code>enum class</code> — но проблема в том, что это будут другие типы, и один в другой сами по себе конвертироваться не будут. Поэтому остановился на алиасах и константах в отдельном <code>namespace</code>, для которых использовал все тот же макрос <code>FURI_HH_ALIAS</code>:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>mutex</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">Type</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutexType<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">type</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    FURI_HH_ALIAS Normal <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutexTypeNormal<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    FURI_HH_ALIAS Recursive <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutexTypeRecursive<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  </span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>В итоге, мои заголовочные файлы стали выглядеть как-то так:</p>
<details>
<summary>mutex.hh</summary>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#pragma</span> once
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>furi.h<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-double z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&quot;</span>furi/macros.hh<span class="z-punctuation z-definition z-string z-end z-c++">&quot;</span></span>
</span></span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-double z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&quot;</span>furi/own.hh<span class="z-punctuation z-definition z-string z-end z-c++">&quot;</span></span>
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">Mutex</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutex<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">MutexOwn</span> <span class="z-keyword z-operator z-assignment z-c">=</span> Own<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutex<span class="z-punctuation z-separator z-c++">,</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_free<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">mutex</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">Type</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutexType<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">type</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">      FURI_HH_ALIAS Normal <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutexTypeNormal<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">      FURI_HH_ALIAS Recursive <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutexTypeRecursive<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    </span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    FURI_HH_ALIAS alloc <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_alloc<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    FURI_HH_ALIAS free <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_free<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    FURI_HH_ALIAS acquire <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_acquire<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    FURI_HH_ALIAS release <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_release<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    FURI_HH_ALIAS get_owner <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_get_owner<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  </span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
</details>
<h2 id="vladeiushchie-ukazateli"><a class="anchor" href="#vladeiushchie-ukazateli" title="link to section">#</a>Владеющие указатели</h2>
<p>Следующее неудобство, от которого я хотел бы избавиться — необходимость не забывать вручную освобождать ресурсы. Возможно, я просто слишком привык к языкам, в которых есть <code>using</code>, деструкторы или хотя бы <code>try-finally</code>, но мне действительно бывает сложно следить за этим самому. Особенно в случае ранних возвратов из функций, или передачи владения указателем.</p>
<p>Стандартный "владеющий" указатель в C++ — это <code>std::unique_ptr</code>. Но он мне не подошел по нескольким причинам.</p>
<p>Первая довольно прозаична: <code>std::unique_ptr&lt;T&gt;</code> не конвертируется автоматически в <code>T*</code>, для этого нужно явно вызывать метод <code>.get()</code>. В API Флиппера владение указателем, как правило, в функцию не передается — исключая <code>_free()</code>-функции, конечно. А писать везде <code>.get()</code> получается слишком многословно.</p>
<p>Другая проблема немного сложнее, и связана с тем, как именно устроены API Флиппера и логика.</p>
<p>У <code>std::unique_ptr</code> есть возможность указать вторым параметром шаблона объект <code>Deleter</code>, который <a href="https://en.cppreference.com/w/cpp/memory/unique_ptr/get_deleter">будет отвечать</a> за то, как именно будет освобожден указатель. Логика достаточно простая: для типа <code>T</code> у него должен быть <code>operator()(T*)</code>, который этот указатель и освободит.</p>
<p>Сначала я хотел завести свою структуру <code>Deleter</code>, и просто перегружать ее <code>operator()</code> для каждого из типов в API:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-modifier z-c++">inline</span> <span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++">Deleter<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>Mutex<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-entity z-name z-function z-c++">operator</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>Mutex<span class="z-keyword z-operator z-c">*</span> m<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++"><span class="z-punctuation z-accessor z-c++">::</span><span class="z-variable z-function z-c++">furi_mutex_free</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">m</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></code></pre>
<p>Но довольно быстро выяснилась очень обидная особенность API Флиппера.</p>
<p>Как правило, когда в сишных API фигурируют указатели, они часто "непрозрачные" — не предназначены для разыменования пользователем, а только для использования с этим же самым API. Они обычно реализуются так:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> объявление структуры без указания полей
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c++">struct</span> MyStruct <span class="z-entity z-name z-type z-typedef z-c++">MyStruct</span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> использование в объявлениях функций
</span></span><span class="z-source z-c++">MyStruct<span class="z-keyword z-operator z-c++">*</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">mystruct_alloc</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Но в заголовках Флиппера часто встречается вот такое:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> furi/core/mutex.h
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c">void</span> <span class="z-entity z-name z-type z-typedef z-c++">FuriMutex</span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> furi/core/timer.h
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c">void</span> <span class="z-entity z-name z-type z-typedef z-c++">FuriTimer</span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> furi/code/message_queue.h
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c">void</span> <span class="z-entity z-name z-type z-typedef z-c++">FuriMessageQueue</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Подвох в этом в том, что с точки зрения системы типов все эти объявления — это один и тот же тип! А это значит, что по ним не работают перегрузки, и просто взять и перегрузить один и тот же <code>Deleter::operator()</code> для них не получится.</p>
<p>Пользуясь случаем: если это читают разработчики Флиппера — pls fix.</p>
<p>А я, в итоге, написал небольшую обертку над стандартным <code>std::unique_ptr</code>. Вот так выглядят объявления владеющих указателей:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">MutexOwn</span> <span class="z-keyword z-operator z-assignment z-c">=</span> Own<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMutex<span class="z-punctuation z-separator z-c++">,</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_mutex_free<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">TimerOwn</span> <span class="z-keyword z-operator z-assignment z-c">=</span> Own<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriTimer<span class="z-punctuation z-separator z-c++">,</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_timer_free<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">MessageQueueOwn</span> <span class="z-keyword z-operator z-assignment z-c">=</span> Own<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FuriMessageQueue<span class="z-punctuation z-separator z-c++">,</span> <span class="z-punctuation z-accessor z-double-colon z-c++">::</span>furi_message_queue_free<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>Вот так их можно использовать:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-c++">using</span> <span class="z-keyword z-control z-c++">namespace</span> furi<span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> создание
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  MutexOwn m <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">mutex<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">alloc</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> использование
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-storage z-type z-c">auto</span> thread_id <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">mutex<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">get_owner</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">m</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> освобождение — автоматически
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> но если очень нужно, все еще можно руками
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++">mutex<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-support z-function z-C99 z-c">free</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++">std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">move</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">m</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></code></pre>
<p>А вот так выглядит реализация:</p>
<details>
<summary>own.hh</summary>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#pragma</span> once
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&lt;</span>memory<span class="z-punctuation z-definition z-string z-end z-c++">&gt;</span></span>
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">own</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span> T</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">Free</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-storage z-type z-c">void</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-keyword z-operator z-c">&amp;</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>T<span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  </span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span> T<span class="z-punctuation z-separator z-c++">,</span> own<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>Free<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>T<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> F</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-meta z-class z-c++"><span class="z-storage z-type z-c++">class</span> </span><span class="z-meta z-class z-c++"><span class="z-entity z-name z-class z-c++">Own</span></span><span class="z-meta z-class z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">_Destroy</span></span><span class="z-meta z-struct z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">      <span class="z-storage z-type z-c">void</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">operator()</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">T<span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c++">ptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">F</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">ptr</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span> </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    std<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>unique_ptr<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>T<span class="z-punctuation z-separator z-c++">,</span> _Destroy<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> _ptr<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">  <span class="z-storage z-modifier z-c++">public</span><span class="z-punctuation z-section z-class z-c++">:</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Own</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c++">nullptr</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">_Destroy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">{</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">}</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Own</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">T<span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c++">ptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">ptr<span class="z-punctuation z-separator z-c++">,</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">_Destroy</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">{</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">}</span></span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Own</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-modifier z-c++">const</span> Own<span class="z-keyword z-operator z-c">&amp;</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-keyword z-operator z-assignment z-c++">=</span> <span class="z-storage z-modifier z-c++">delete</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Own</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">Own<span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-keyword z-operator z-assignment z-c++">=</span> <span class="z-storage z-modifier z-c++">default</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    Own<span class="z-keyword z-operator z-c++">&amp;</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">operator=</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-modifier z-c++">const</span> Own<span class="z-keyword z-operator z-c">&amp;</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-keyword z-operator z-assignment z-c++">=</span> <span class="z-storage z-modifier z-c++">delete</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    Own<span class="z-keyword z-operator z-c++">&amp;</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">operator=</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">Own<span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-keyword z-operator z-assignment z-c++">=</span> <span class="z-storage z-modifier z-c++">default</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">operator</span> T<span class="z-keyword z-operator z-c">*</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span> <span class="z-keyword z-control z-flow z-return z-c++">return</span> _ptr<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">get</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span> <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">operator</span> <span class="z-storage z-modifier z-c++">const</span> T<span class="z-keyword z-operator z-c">*</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-storage z-modifier z-c++">const</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span> <span class="z-keyword z-control z-flow z-return z-c++">return</span> _ptr<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">get</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span> <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    T<span class="z-keyword z-operator z-c++">*</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">get_mut</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> <span class="z-storage z-modifier z-c++">const</span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"> <span class="z-keyword z-control z-flow z-return z-c++">return</span> _ptr<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">get</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span> </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">  </span></span><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
</details>
<h2 id="defer"><a class="anchor" href="#defer" title="link to section">#</a>defer</h2>
<p>Недостаток RAII я чувствовал не только для выделения-освобождения памяти, но и многих других действий. Например, захвата и освобождения мьютексов. Или удаления <code>ViewPort</code> из GUI перед вызовом <code>view_port_free()</code> — этот баг я искал довольно долго. Писать для каждого такого случая свой guard-класс мне не хотелось, поэтому позаимствовал идею из других языков — реализовал <code>defer</code>.</p>
<p>Использовать его можно примерно так:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++">mutex<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">acquire</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">m</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">defer</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++">mutex<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">release</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">m</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> здесь мьютекс освобожден
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++">gui<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">add_view_port</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">gui<span class="z-punctuation z-separator z-c++">,</span> vp</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">defer</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-function-call z-c++">gui<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">remove_view_port</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">gui<span class="z-punctuation z-separator z-c++">,</span> vp</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span><span class="z-source z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> здесь ViewPort удален
</span></span></code></pre>
<p>Реализация ничем не примечательна — идея довольно стара:</p>
<details>
<summary>defer.hh</summary>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#pragma</span> once
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-preprocessor z-include z-c++"><span class="z-keyword z-control z-import z-include z-c++">#include</span> <span class="z-string z-quoted z-double z-include z-c++"><span class="z-punctuation z-definition z-string z-begin z-c++">&quot;</span>furi/macros.hh<span class="z-punctuation z-definition z-string z-end z-c++">&quot;</span></span>
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span> F</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-meta z-class z-c++"><span class="z-storage z-type z-c++">class</span> </span><span class="z-meta z-class z-c++"><span class="z-entity z-name z-class z-c++">Defer</span></span><span class="z-meta z-class z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    F _fn<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">  <span class="z-storage z-modifier z-c++">public</span><span class="z-punctuation z-section z-class z-c++">:</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Defer</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">F <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span><span class="z-variable z-parameter z-c++">fn</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">_fn</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">fn</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-destructor z-c++"><span class="z-entity z-name z-function z-destructor z-c++">~Defer</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">_fn</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span> </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++">  </span></span><span class="z-meta z-class z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-preprocessor z-macro z-c++"><span class="z-keyword z-control z-import z-define z-c++">#define</span></span><span class="z-meta z-preprocessor z-macro z-c++"> <span class="z-entity z-name z-function z-preprocessor z-c++">FURI_HH_CONCAT_IMPL</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-variable z-parameter z-c++">x</span><span class="z-punctuation z-separator z-c++">,</span><span class="z-variable z-parameter z-c++">y</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c++"> x##y</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-preprocessor z-macro z-c++"><span class="z-keyword z-control z-import z-define z-c++">#define</span></span><span class="z-meta z-preprocessor z-macro z-c++"> <span class="z-entity z-name z-function z-preprocessor z-c++">FURI_HH_CONCAT</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-variable z-parameter z-c++">x</span><span class="z-punctuation z-separator z-c++">,</span><span class="z-variable z-parameter z-c++">y</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c++"> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">FURI_HH_CONCAT_IMPL</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">x<span class="z-punctuation z-separator z-c++">,</span>y</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-preprocessor z-macro z-c++"><span class="z-keyword z-control z-import z-define z-c++">#define</span></span><span class="z-meta z-preprocessor z-macro z-c++"> <span class="z-entity z-name z-function z-preprocessor z-c++">defer</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-variable z-parameter z-c++">code</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c++"> <span class="z-storage z-type z-c">auto</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">FURI_HH_CONCAT</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">_defer_<span class="z-punctuation z-separator z-c++">,</span> __COUNTER__</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Defer</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">{</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-keyword z-operator z-c">&amp;</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span> code<span class="z-punctuation z-terminator z-c++">;</span> <span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">}</span></span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
</details>
<h2 id="kolbeki"><a class="anchor" href="#kolbeki" title="link to section">#</a>Колбеки</h2>
<p>В API Флиппера довольно много функций принимают колбеки — для того, чтобы уведомлять о событиях, или запускать код в другом потоке. Организовано это довольно стандартно для сишных API:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> в функцию передается указатель на колбек, а также указатель на ее контекст:
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">furi_timer_pending_callback</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">FuriTimerPendigCallback <span class="z-variable z-parameter z-c++">callback</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c++">void</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c++">context</span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-support z-type z-stdint z-c">uint32_t</span> <span class="z-variable z-parameter z-c++">arg</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> когда колбек будет вызван, этот контекст ему будет передан:
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c">void</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-keyword z-operator z-c">*</span>FuriTimerPendigCallback<span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span> context<span class="z-punctuation z-separator z-c++">,</span> <span class="z-support z-type z-stdint z-c">uint32_t</span> arg<span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Неудобств в таком подходе два.</p>
<p>Во-первых, это означает, что колбеки бывает нужно определять довольно далеко от места их использования. Для небольших колбеков это очень неудобно:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">my_callback</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-storage z-type z-c++">void</span><span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c++">ctx</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"> </span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span>...<span class="z-punctuation z-definition z-comment z-c">*/</span></span> </span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">my_long_function</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"> </span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">mylib_use_callback</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">ctx<span class="z-punctuation z-separator z-c++">,</span> my_callback</span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>Вернее, означало в C — а в C++ есть <a href="https://stackoverflow.com/a/18889029/7214622">"положительные" лямбды</a>! Они не могут захватывать переменные, но превращаются в указатель на функцию.</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-type z-c">void</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">my_long_function</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"> </span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">mylib_use_callback</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">ctx<span class="z-punctuation z-separator z-c++">,</span> <span class="z-keyword z-operator z-arithmetic z-c">+</span><span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span> ctx<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span>...<span class="z-punctuation z-definition z-comment z-c">*/</span></span> <span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>Вторая проблема связана с типизацией. Единственный способ в сишном API сделать функцию обобщенной относительно контекста колбека — обращаться с ним как с <code>void*</code>. Но это приводит к необходимости кастов, и к возможности случайно скастить не в тот тип.</p>
<p>В случае типов <code>FuriMutex</code> и <code>FuriTimer</code>, как мы видели выше, компилятор при этом даже не ругнется.</p>
<p>Поэтому я решил написать свою простую структуру-обертку для пары "колбек-контекст"... но очень быстро наткнулся на еще одно не очень удачное — с точки зрения C++ — решение в API Флиппера:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> где-то контекст передается первым аргументом...
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c">void</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-keyword z-operator z-c">*</span>FuriTimerPendigCallback<span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span> context<span class="z-punctuation z-separator z-c++">,</span> <span class="z-support z-type z-stdint z-c">uint32_t</span> arg<span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> ...а где-то — последним!
</span></span><span class="z-source z-c++"><span class="z-storage z-type z-c++">typedef</span> <span class="z-storage z-type z-c">void</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-keyword z-operator z-c">*</span>ViewPortDrawCallback<span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>Canvas<span class="z-keyword z-operator z-c">*</span> canvas<span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span> context<span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<p>Я очень долго ломал голову над тем, как написать одну обертку на оба случая, но потом плюнул и просто написал две:</p>
<details>
<summary>callback.hh</summary>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-meta z-preprocessor z-c++"><span class="z-keyword z-control z-import z-c++">#pragma</span> once
</span></span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">furi</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-namespace z-c++"><span class="z-keyword z-control z-c++">namespace</span> </span><span class="z-meta z-namespace z-c++"><span class="z-entity z-name z-namespace z-c++">cb</span></span><span class="z-meta z-namespace z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span><span class="z-keyword z-operator z-variadic z-c++">...</span> As</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">FnPtr</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-storage z-type z-c">void</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span><span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>As<span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  </span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> здесь контекст — первый агрумент
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span><span class="z-keyword z-operator z-variadic z-c++">...</span> As</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Cb</span></span><span class="z-meta z-struct z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">FnPtr</span> <span class="z-keyword z-operator z-assignment z-c">=</span> cb<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FnPtr<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-separator z-c++">,</span> As<span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c++">*</span> ctx<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    FnPtr fn_ptr<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Cb</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">ctx</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c++">nullptr</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c++">nullptr</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Cb</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">FnPtr <span class="z-variable z-parameter z-c++">fn_ptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">ctx</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c++">nullptr</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span> C</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Cb</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">C<span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c++">ctx</span><span class="z-punctuation z-separator z-c++">,</span> cb<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FnPtr<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>C<span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-separator z-c++">,</span> As<span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-variable z-parameter z-c++">fn_ptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++">
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++">      </span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">ctx</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>ctx<span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-constructor z-initializer-list z-c++">      <span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-word z-cast z-c++">reinterpret_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>FnPtr<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>fn_ptr<span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-constructor z-initializer-list z-c++">      </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">void</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">operator()</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">As<span class="z-keyword z-operator z-variadic z-c">...</span> <span class="z-variable z-parameter z-c++">args</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">      <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>fn_ptr<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">ctx<span class="z-punctuation z-separator z-c++">,</span> args<span class="z-keyword z-operator z-variadic z-c">...</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">  </span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> а здесь — второй
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> хотел честно сделать последним,
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> но вывод типов почему-то сломался
</span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++">  <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span> A1<span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c++">class</span><span class="z-keyword z-operator z-variadic z-c++">...</span> As</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-meta z-struct z-c++"><span class="z-storage z-type z-c++">struct</span> </span><span class="z-meta z-struct z-c++"><span class="z-entity z-name z-struct z-c++">Cb2</span></span><span class="z-meta z-struct z-c++"> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-keyword z-control z-c++">using</span> <span class="z-entity z-name z-type z-using z-c++">FnPtr</span> <span class="z-keyword z-operator z-assignment z-c">=</span> cb<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FnPtr<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>A1<span class="z-punctuation z-separator z-c++">,</span> <span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-separator z-c++">,</span> As<span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c++">*</span> ctx<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    FnPtr fn_ptr<span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Cb2</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">ctx</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c++">nullptr</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c++">nullptr</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Cb2</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">FnPtr <span class="z-variable z-parameter z-c++">fn_ptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">ctx</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-constant z-language z-c++">nullptr</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span><span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-meta z-template z-c++"><span class="z-storage z-type z-template z-c++">template</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span></span><span class="z-meta z-template z-c++"><span class="z-storage z-type z-c++">class</span> C</span><span class="z-meta z-template z-c++"><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span></span> <span class="z-meta z-method z-constructor z-c++"><span class="z-entity z-name z-function z-constructor z-c++">Cb2</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">C<span class="z-keyword z-operator z-c">*</span> <span class="z-variable z-parameter z-c++">ctx</span><span class="z-punctuation z-separator z-c++">,</span> cb<span class="z-punctuation z-accessor z-double-colon z-c++">::</span>FnPtr<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>A1<span class="z-punctuation z-separator z-c++">,</span> C<span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-separator z-c++">,</span> As<span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-variable z-parameter z-c++">fn_ptr</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++">
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++">      </span><span class="z-meta z-method z-constructor z-initializer-list z-c++"><span class="z-punctuation z-separator z-initializer-list z-c++">:</span> <span class="z-variable z-other z-readwrite z-member z-c++">ctx</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-word z-cast z-c++">static_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-storage z-type z-c">void</span><span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>ctx<span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-constructor z-initializer-list z-c++">      <span class="z-punctuation z-separator z-c++">,</span> <span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span><span class="z-meta z-group z-c++"><span class="z-keyword z-operator z-word z-cast z-c++">reinterpret_cast</span><span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>FnPtr<span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>fn_ptr<span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span>
</span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-constructor z-initializer-list z-c++">      </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">    <span class="z-storage z-type z-c">void</span> <span class="z-meta z-method z-c++"><span class="z-entity z-name z-function z-c++">operator()</span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method z-parameters z-c++"><span class="z-meta z-group z-c++">A1 <span class="z-variable z-parameter z-c++">a1</span><span class="z-punctuation z-separator z-c++">,</span> As<span class="z-keyword z-operator z-variadic z-c">...</span> <span class="z-variable z-parameter z-c++">args</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-method z-c++"> </span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">      <span class="z-keyword z-control z-c++">if</span> <span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>fn_ptr<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">fn_ptr</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">a1<span class="z-punctuation z-separator z-c++">,</span> ctx<span class="z-punctuation z-separator z-c++">,</span> args<span class="z-keyword z-operator z-variadic z-c">...</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++">    </span></span><span class="z-meta z-method z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></span></span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++">  </span></span><span class="z-meta z-struct z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-namespace z-c++"><span class="z-meta z-block z-c++"></span><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
</details>
<p>Кроме этого, в самих функциях, принимающих колбеки, тоже есть неконсистентность: в некоторых колбек с контекстом — это последние аргументы, в некоторых нет, в а некоторых между ними стоит еще один аргумент. Поэтому для таких функций я все-таки решил написать обертки. Вот пример:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-storage z-modifier z-c++">inline</span> <span class="z-storage z-type z-c">auto</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">alloc_cb</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">Type <span class="z-variable z-parameter z-c++">type</span><span class="z-punctuation z-separator z-c++">,</span> Cb<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-variable z-parameter z-c++">cb</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"> </span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">alloc</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">cb<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-punctuation z-separator z-c++">,</span> type<span class="z-punctuation z-separator z-c++">,</span> cb<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">ctx</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-storage z-modifier z-c++">inline</span> <span class="z-storage z-type z-c">auto</span> <span class="z-meta z-function z-c++"><span class="z-meta z-toc-list z-full-identifier z-c++"><span class="z-entity z-name z-function z-c++">set_draw_callback_cb2</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function z-parameters z-c++"><span class="z-meta z-group z-c++">ViewPort <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c++">vp</span><span class="z-punctuation z-separator z-c++">,</span> Cb2<span class="z-punctuation z-section z-generic z-begin z-c++">&lt;</span>Canvas<span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-generic z-end z-c++">&gt;</span> <span class="z-variable z-parameter z-c++">cb2</span><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-meta z-function z-c++"> </span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++">  <span class="z-keyword z-control z-flow z-return z-c++">return</span> <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">set_draw_callback</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">vp<span class="z-punctuation z-separator z-c++">,</span> cb2<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">fn_ptr</span><span class="z-punctuation z-separator z-c++">,</span> cb2<span class="z-punctuation z-accessor z-dot z-c++">.</span><span class="z-variable z-other z-readwrite z-member z-c++">ctx</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"></span></span><span class="z-meta z-function z-c++"><span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span>
</span></code></pre>
<p>Использовать их можно как-то так:</p>
<pre data-lang="cpp" class="language-cpp z-code"><code class="language-cpp" data-lang="cpp"><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> со статическим методом
</span></span><span class="z-source z-c++"><span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">set_draw_callback_cb2</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">_vp<span class="z-punctuation z-separator z-c++">,</span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span><span class="z-variable z-language z-c++">this</span><span class="z-punctuation z-separator z-c++">,</span> _draw<span class="z-punctuation z-section z-block z-end z-c++">}</span></span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span><span class="z-source z-c++">
</span><span class="z-source z-c++"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> с лямбдой и дополнительным синтаксическим сахаром
</span></span><span class="z-source z-c++">_timer <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c++">timer<span class="z-punctuation z-accessor z-double-colon z-c++">::</span><span class="z-variable z-function z-c++">alloc_cb</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">  Periodic<span class="z-punctuation z-separator z-c++">,</span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++">  <span class="z-meta z-function-call z-c++"><span class="z-variable z-function z-c++">Ctx</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">{</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-variable z-language z-c++">this</span></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">}</span></span></span> <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-keyword z-operator z-arithmetic z-c">+</span><span class="z-meta z-brackets z-c++"><span class="z-punctuation z-section z-brackets z-begin z-c++">[</span><span class="z-punctuation z-section z-brackets z-end z-c++">]</span></span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span>SecondTimer <span class="z-keyword z-operator z-c">*</span>self<span class="z-punctuation z-section z-group z-end z-c++">)</span></span> <span class="z-meta z-block z-c++"><span class="z-punctuation z-section z-block z-begin z-c++">{</span> self<span class="z-punctuation z-accessor z-arrow z-c++">-&gt;</span><span class="z-meta z-method-call z-c++"><span class="z-variable z-function z-member z-c++">_on_tick</span><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-begin z-c++">(</span></span></span><span class="z-meta z-method-call z-c++"></span><span class="z-meta z-method-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span> <span class="z-punctuation z-section z-block z-end z-c++">}</span></span>
</span></span></span><span class="z-source z-c++"><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"></span></span><span class="z-meta z-function-call z-c++"><span class="z-meta z-group z-c++"><span class="z-punctuation z-section z-group z-end z-c++">)</span></span></span><span class="z-punctuation z-terminator z-c++">;</span>
</span></code></pre>
<h2 id="zakliuchenie"><a class="anchor" href="#zakliuchenie" title="link to section">#</a>Заключение</h2>
<p>Это были некоторые из примеров того, как в написании приложения для Флиппера мне помог Си-с-классами — а точнее, почти без классов, но с неймспейсами, RAII и так далее. Еще несколько примеров есть <a href="https://github.com/iliazeus/furi-cpp">в моем репозитории</a> — например, вот <a href="https://github.com/iliazeus/furi-cpp/blob/7e7536ab/app/app.hh#L93-L140">матчинг по типам событий</a> с помощью <code>std::variant</code>. Однако мне кажется, что их достаточно, чтобы продемонстрировать, что C++ может помочь в около-эмбеддед разработке. По крайней мере, если применять дозированно.</p>

    </main>

    <footer>
      <nav>
        <ul class="horizontal small">
          <li><a rel="me" href="https://github.com/iliazeus">github</a></li>
          <li><a rel="me" href="https://habr.com/users/iliazeus">habr</a></li>
          <li><a rel="me" href="https://lor.sh/@iliazeus">mastodon</a></li>
          <li><a rel="me" href="mailto:iliazeus@proton.me">mailto</a></li>
          <li>made with <a href="https://www.getzola.org/">Zola</a></li>
        </ul>
      </nav>
    </footer>
  </body>
</html>
